{{ header }}

{% from "_helpers.j2" import board_name, board_fpga_part, safe_attr %}
puts "Adding constraint files..."

# Get script directory for reliable path resolution
set script_dir [file dirname [info script]]

# Only include constraint files provided by PCILeech discovery and generation
set already_added_files [list]

# Generated XDC path (copied by the builder)
{% if generated_xdc_path %}
set generated_xdc "{{ generated_xdc_path }}"
if {[file exists $generated_xdc]} {
    if {[lsearch -exact $already_added_files $generated_xdc] == -1} {
        add_files -fileset constrs_1 -norecurse $generated_xdc
        lappend already_added_files $generated_xdc
        puts "Added generated XDC constraints: $generated_xdc"
    }
} else {
    puts "WARNING: Generated XDC path does not exist: $generated_xdc"
}
{% endif %}

# Explicit constraint files provided by the builder
{% if constraint_files %}
set pcileech_xdc_files [list \
{% for f in constraint_files %}    "{{ f }}" \
{% endfor %}]
foreach xdc_file $pcileech_xdc_files {
    if {[file exists $xdc_file]} {
        if {[lsearch -exact $already_added_files $xdc_file] == -1} {
            add_files -fileset constrs_1 -norecurse $xdc_file
            lappend already_added_files $xdc_file
            puts "  Added PCILeech XDC: $xdc_file"
        }
    } else {
        puts "WARNING: PCILeech XDC not found: $xdc_file"
    }
}
{% endif %}

# Generate device-specific timing constraints
puts "Adding device-specific timing constraints..."
# Try to use board-specific XDC constraints if board type is specified
puts "Attempting to load board-specific XDC constraints for: {{ board_name(board) }}"

{%- if board_xdc_content is defined and board_xdc_content %}
# Load XDC constraints from PCILeech repository
# This will be populated by the constraint generation system
# with actual XDC content from the PCILeech FPGA repository
# Write board XDC content to temporary file with safe quoting
set board_auto_xdc_file [file join $script_dir "{{ board_name(board) }}_auto.xdc"]
set fp [open $board_auto_xdc_file w]
# Use subst with -nobackslashes -nocommands to safely write XDC content
puts $fp [subst -nobackslashes -nocommands {
{{ board_xdc_content }}
}]
close $fp
add_files -fileset constrs_1 -norecurse $board_auto_xdc_file
read_xdc $board_auto_xdc_file
puts "Added auto-generated board XDC: $board_auto_xdc_file"
{%- else %}
# No board-specific XDC available, using generic constraints
puts "WARNING: No board-specific XDC constraints available for {{ board_name(board) }}"
puts "Using generic timing constraints only. You may need to add board-specific pin assignments."
{%- endif %}

# Generate device-specific timing constraints file
{# Determine safe system clock frequency in MHz. Prefer explicit context key; otherwise, use any board hint; finally fall back to 100. #}
{% set _sys_clk_mhz = (sys_clk_freq_mhz | safe_int(0)) if (sys_clk_freq_mhz is defined) else 0 %}
{% if _sys_clk_mhz <= 0 %}
    {% set _sys_clk_mhz = (safe_attr(board, 'sys_clk_mhz', 0) | int) %}
{% endif %}
{% if _sys_clk_mhz <= 0 %}
    {% set _sys_clk_mhz = 100 %}
{% endif %}
{% set sys_clk_period = (1000.0 / _sys_clk_mhz) | round(3) %}
set timing_constraints_content {
# Device-specific timing constraints for {{ device.vendor_id }}:{{ device.device_id }}
# Board: {{ board_name(board) }}
# System Clock: {{ _sys_clk_mhz }} MHz (period: {{ sys_clk_period }} ns)

# NOTE: PCIe transceiver pins (pci_exp_*) are managed by PCIE IP core - do not constrain
# System clock feeds IBUFDS_GTE2; IOSTANDARD handled by clock buffer primitive

# System clock pin assignments (board-dependent: differential or single-ended)
{%- set sys_clk_p_pin = safe_attr(board, 'sys_clk_p_pin', '') -%}
{%- set sys_clk_n_pin = safe_attr(board, 'sys_clk_n_pin', '') -%}
{%- set clk_pin = safe_attr(board, 'clk_pin', '') -%}

{%- if sys_clk_p_pin and sys_clk_n_pin %}
# Differential system clock (for boards like AC701, Acorn, SP605)
# System reference clock pin assignments for {{ board_name(board) }}
set_property PACKAGE_PIN {{ sys_clk_p_pin }} [get_ports sys_clk_p]
set_property PACKAGE_PIN {{ sys_clk_n_pin }} [get_ports sys_clk_n]
# Note: IOSTANDARD for differential clocks is typically LVDS_25 or DIFF_SSTL15
# The IBUFDS_GTE2 primitive handles the clock buffer, IOSTANDARD is optional
# set_property IOSTANDARD LVDS_25 [get_ports {sys_clk_p sys_clk_n}]

{%- elif clk_pin %}
# Single-ended system clock (most PCILeech boards: ScreamerM2, EnigmaX1, CaptainDMA, etc.)
# Clock pin assignment for {{ board_name(board) }}
set_property PACKAGE_PIN {{ clk_pin }} [get_ports clk]
set_property IOSTANDARD LVCMOS33 [get_ports clk]

{%- else %}
# WARNING: No clock pin assignments provided for {{ board_name(board) }}
# This board needs either:
#   - Differential clock: sys_clk_p_pin + sys_clk_n_pin (for AC701, Acorn, SP605)
#   - Single-ended clock: clk_pin (for most PCILeech boards)
# Add appropriate clock pin(s) to board configuration to prevent UCIO-1 DRC errors
{%- endif %}

# IBUFDS_GTE2 LOC constraint - required for 7-series devices
{%- set pcie_refclk_loc = safe_attr(board, 'pcie_refclk_loc', '') -%}
{%- if pcie_refclk_loc %}
# PCIe reference clock buffer location for {{ board_name(board) }}
set_property LOC {{ pcie_refclk_loc }} [get_cells pcie_refclk_ibuf]
{%- else %}
# WARNING: No IBUFDS_GTE2 LOC constraint provided for {{ board_name(board) }}
# This will cause DRC errors during place_design
# Please add pcie_refclk_loc to board configuration (e.g., IBUFDS_GTE2_X0Y1)
{%- endif %}

# System reset pin assignment
{%- set sys_rst_n_pin = safe_attr(board, 'sys_rst_n_pin', '') -%}
{%- if sys_rst_n_pin %}
# System reset pin for {{ board_name(board) }}
set_property PACKAGE_PIN {{ sys_rst_n_pin }} [get_ports sys_rst_n]
set_property IOSTANDARD LVCMOS33 [get_ports sys_rst_n]
set_property PULLUP TRUE [get_ports sys_rst_n]
{%- else %}
# NOTE: No sys_rst_n pin assignment in board configuration
# Many PCILeech boards use pcie_perst_n as the system reset
# If your board requires explicit sys_rst_n, add sys_rst_n_pin to board configuration
{%- endif %}

# Timing Constraints
# Create clock constraint for the system reference clock
# Period depends on board clock frequency (typically 100 MHz)
{%- set sys_clk_p_pin = safe_attr(board, 'sys_clk_p_pin', '') -%}
{%- set clk_pin = safe_attr(board, 'clk_pin', '') -%}
{%- set waveform_half = (sys_clk_period / 2) | round(3) -%}
{% if sys_clk_p_pin %}
# Differential clock timing (sys_clk_p/sys_clk_n)
create_clock -period {{ sys_clk_period }} -name sys_clk_p -waveform {0.000 {{ waveform_half }}} [get_ports sys_clk_p]
{% elif clk_pin %}
# Single-ended clock timing (clk)
create_clock -period {{ sys_clk_period }} -name net_clk -waveform {0.000 {{ waveform_half }}} [get_ports clk]
{% else %}
# Default clock constraint (assumes sys_clk_p port exists)
create_clock -period {{ sys_clk_period }} -name sys_clk_p [get_ports sys_clk_p]
{% endif %}

# PCIe reference clock timing constraint (on the buffered clock net)
# This is the output of the IBUFDS_GTE2 primitive
{%- set pcie_clk_period = 10.0 %}  {# 100 MHz PCIe reference clock #}
create_clock -name pcie_refclk_p -period {{ pcie_clk_period }} [get_nets pcie_clk_p]

# System reset timing - use false path (asynchronous reset)
# Reset signals are typically asynchronous and don't need setup/hold timing
set_false_path -from [get_ports sys_rst_n]

# PCIe IP Core Clocks (generated by IP, constraints added automatically)
# Reference: refclk={{ pcie_refclk_freq | default('100 MHz') }}
# User clocks: userclk1={{ pcie_userclk1_freq | default('N/A') }}, userclk2={{ pcie_userclk2_freq | default('N/A') }}
}

# Write timing constraints to file
set constraints_file [file join $script_dir "device_constraints.xdc"]
set fp [open $constraints_file w]
puts $fp $timing_constraints_content
close $fp
add_files -fileset constrs_1 -norecurse $constraints_file
read_xdc $constraints_file
set_property PROCESSING_ORDER LATE [get_files $constraints_file]
puts "Generated device constraints file: $constraints_file"

# Quality-of-life tweaks for USB-heavy designs
{% if board and board.features is defined and board.features %}
set_param xicom.use_bs_reader 1
puts "Enabled fast bitstream reader for FT601 board"
{% endif %}

puts "Constraints setup completed"